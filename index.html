<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Progress Report Generator</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;
    const { FileText, Download, User, Upload, X, Plus } = lucide;

    function StudentProgressReport() {
      const [students, setStudents] = useState([]);
      const [selectedStudent, setSelectedStudent] = useState('');
      const [error, setError] = useState('');
      const [uploadedFiles, setUploadedFiles] = useState([]);

      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target.result;
          const lines = content.split('\n');
          
          // Extract metadata from first two lines
          const titleLine = lines[0] || '';
          const metadataLine = lines[1] || '';
          
          // Parse the data (skip first 2 header rows)
          const data = lines.slice(2).join('\n');
          const parsed = Papa.parse(data, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true
          });

          setUploadedFiles(prev => [...prev, {
            id: Date.now() + Math.random(),
            name: file.name,
            data: parsed.data,
            title: titleLine.split(',')[0].trim(),
            metadata: metadataLine
          }]);
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset input
      };

      const removeFile = (fileId) => {
        setUploadedFiles(prev => prev.filter(f => f.id !== fileId));
      };

      const generateReports = () => {
        if (uploadedFiles.length === 0) {
          setError('Please upload at least one assessment file');
          return;
        }

        try {
          // Get all unique student names from all files
          const allStudentNames = new Set();
          uploadedFiles.forEach(file => {
            file.data.forEach(student => {
              if (student.StudentName) {
                allStudentNames.add(student.StudentName);
              }
            });
          });

          // Create combined data for each student
          const combinedData = Array.from(allStudentNames).map(studentName => {
            const studentUnits = uploadedFiles.map((file, index) => {
              const studentData = file.data.find(s => s.StudentName === studentName);
              
              if (!studentData) return null;

              const assessments = Object.entries(studentData)
                .filter(([key]) => !['StudentName', 'Mean', 'Median', 'Mode'].includes(key))
                .map(([name, score]) => ({ name, score }));

              return {
                title: file.title || `Unit ${index + 1}`,
                fileName: file.name,
                assessments: assessments,
                mean: studentData.Mean,
                median: studentData.Median,
                mode: studentData.Mode
              };
            }).filter(unit => unit !== null);

            return {
              name: studentName,
              units: studentUnits
            };
          });

          setStudents(combinedData);
          setError('');
        } catch (err) {
          setError('Error processing data: ' + err.message);
        }
      };

      const getScoreColor = (score) => {
        if (score === 0 || score === null) return 'text-gray-400';
        if (score >= 4.5) return 'text-green-600';
        if (score >= 3.5) return 'text-blue-600';
        if (score >= 2.5) return 'text-yellow-600';
        return 'text-red-600';
      };

      const getScoreBackground = (score) => {
        if (score === 0 || score === null) return 'bg-gray-100';
        if (score >= 4.5) return 'bg-green-50';
        if (score >= 3.5) return 'bg-blue-50';
        if (score >= 2.5) return 'bg-yellow-50';
        return 'bg-red-50';
      };

      const getPerformanceLevel = (mean) => {
        if (mean >= 4.5) return 'Excellent';
        if (mean >= 4.0) return 'Proficient';
        if (mean >= 3.0) return 'Developing';
        return 'Needs Support';
      };

      const selectedStudentData = students.find(s => s.name === selectedStudent);

      const printReport = () => {
        window.print();
      };

      if (students.length === 0) {
        return (
          <div className="min-h-screen bg-gray-50 p-6">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-8">
                <div className="flex items-center gap-3 mb-6">
                  <FileText className="w-8 h-8 text-blue-600" />
                  <h1 className="text-3xl font-bold text-gray-800">Student Progress Report Generator</h1>
                </div>

                {error && (
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p className="text-red-800">{error}</p>
                  </div>
                )}

                <div className="space-y-6">
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <div className="flex items-center gap-3 mb-3">
                      <Upload className="w-5 h-5 text-blue-600" />
                      <label className="block text-sm font-medium text-gray-700">
                        Upload Assessment Files (CSV)
                      </label>
                    </div>
                    <input
                      type="file"
                      accept=".csv"
                      onChange={handleFileUpload}
                      className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                    />
                    <p className="text-xs text-gray-500 mt-2">You can upload multiple files - click "Choose File" again to add more</p>
                  </div>

                  {uploadedFiles.length > 0 && (
                    <div className="space-y-2">
                      <h3 className="text-sm font-semibold text-gray-700 mb-2">Uploaded Files:</h3>
                      {uploadedFiles.map((file) => (
                        <div key={file.id} className="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                          <div className="flex items-center gap-2">
                            <FileText className="w-4 h-4 text-green-600" />
                            <div>
                              <p className="text-sm font-medium text-gray-800">{file.name}</p>
                              <p className="text-xs text-gray-600">{file.data.length} students</p>
                            </div>
                          </div>
                          <button
                            onClick={() => removeFile(file.id)}
                            className="text-red-600 hover:text-red-800"
                          >
                            <X className="w-5 h-5" />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}

                  <button
                    onClick={generateReports}
                    disabled={uploadedFiles.length === 0}
                    className="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    <Plus className="w-5 h-5" />
                    Generate Progress Reports ({uploadedFiles.length} file{uploadedFiles.length !== 1 ? 's' : ''})
                  </button>
                </div>

                <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-gray-700 mb-2">
                    <strong>Instructions:</strong>
                  </p>
                  <ul className="text-sm text-gray-700 space-y-1 list-disc list-inside">
                    <li>Upload as many CSV assessment files as you need</li>
                    <li>Each file should have student names and assessment scores</li>
                    <li>Files will be combined into one comprehensive report per student</li>
                    <li>Click "Generate Progress Reports" when all files are uploaded</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-6">
          <div className="max-w-4xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6 print:shadow-none">
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-3">
                  <FileText className="w-8 h-8 text-blue-600" />
                  <h1 className="text-3xl font-bold text-gray-800">Student Progress Report</h1>
                </div>
                <button
                  onClick={() => {
                    setStudents([]);
                    setSelectedStudent('');
                    setUploadedFiles([]);
                  }}
                  className="text-sm text-blue-600 hover:text-blue-800 print:hidden"
                >
                  Upload New Files
                </button>
              </div>

              <div className="mb-6 print:hidden">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Select Student
                </label>
                <select
                  value={selectedStudent}
                  onChange={(e) => setSelectedStudent(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">-- Choose a student --</option>
                  {students.map((student) => (
                    <option key={student.name} value={student.name}>
                      {student.name}
                    </option>
                  ))}
                </select>
              </div>

              {selectedStudentData && (
                <div>
                  <button
                    onClick={printReport}
                    className="mb-6 flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 print:hidden"
                  >
                    <Download className="w-4 h-4" />
                    Print/Save Report
                  </button>

                  <div className="border-t-4 border-blue-600 pt-6">
                    <div className="flex items-center gap-3 mb-6">
                      <User className="w-6 h-6 text-blue-600" />
                      <h2 className="text-2xl font-bold text-gray-800">{selectedStudentData.name}</h2>
                    </div>

                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                      <p className="text-sm text-gray-600">Subject: <span className="font-semibold">Biology</span></p>
                      <p className="text-sm text-gray-600">Period: <span className="font-semibold">4</span></p>
                      <p className="text-sm text-gray-600">Teacher: <span className="font-semibold">Monica</span></p>
                      <p className="text-sm text-gray-600">Term: <span className="font-semibold">Hex 1</span></p>
                      <p className="text-sm text-gray-600">Total Units: <span className="font-semibold">{selectedStudentData.units.length}</span></p>
                    </div>

                    {selectedStudentData.units.map((unit, unitIndex) => (
                      <div key={unitIndex} className="mb-8">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 border-b-2 border-gray-200 pb-2">
                          {unit.title}
                        </h3>
                        
                        <div className="grid grid-cols-3 gap-4 mb-4">
                          <div className="bg-gray-50 p-3 rounded-lg">
                            <p className="text-xs text-gray-600 mb-1">Mean Score</p>
                            <p className={`text-2xl font-bold ${getScoreColor(unit.mean)}`}>
                              {unit.mean?.toFixed(2) || 'N/A'}
                            </p>
                          </div>
                          <div className="bg-gray-50 p-3 rounded-lg">
                            <p className="text-xs text-gray-600 mb-1">Median</p>
                            <p className={`text-2xl font-bold ${getScoreColor(unit.median)}`}>
                              {unit.median || 'N/A'}
                            </p>
                          </div>
                          <div className="bg-gray-50 p-3 rounded-lg">
                            <p className="text-xs text-gray-600 mb-1">Performance</p>
                            <p className="text-lg font-bold text-gray-800">
                              {getPerformanceLevel(unit.mean)}
                            </p>
                          </div>
                        </div>

                        <div className="space-y-2">
                          {unit.assessments.map((assessment, idx) => (
                            <div key={idx} className={`p-3 rounded-lg ${getScoreBackground(assessment.score)}`}>
                              <div className="flex justify-between items-center">
                                <span className="text-sm text-gray-700">{assessment.name}</span>
                                <span className={`text-lg font-bold ${getScoreColor(assessment.score)}`}>
                                  {assessment.score !== null && assessment.score !== undefined ? assessment.score : 'Not Submitted'}
                                </span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}

                    <div className="mt-8 p-4 bg-gray-50 rounded-lg border-l-4 border-blue-600">
                      <h4 className="font-bold text-gray-800 mb-2">Overall Summary</h4>
                      <p className="text-sm text-gray-700">
                        Overall Mean: <span className="font-bold">
                          {(selectedStudentData.units.reduce((sum, unit) => sum + (unit.mean || 0), 0) / selectedStudentData.units.length).toFixed(2)}
                        </span>
                      </p>
                      <p className="text-sm text-gray-700 mt-1">
                        Total Assessments: <span className="font-bold">
                          {selectedStudentData.units.reduce((sum, unit) => sum + unit.assessments.length, 0)}
                        </span>
                      </p>
                      <p className="text-xs text-gray-600 mt-2">
                        Scale: 5 = Excellent, 4 = Proficient, 3 = Developing, 2 = Beginning, 1-0 = Needs Support
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {!selectedStudentData && (
                <div className="text-center py-12 text-gray-500">
                  <User className="w-16 h-16 mx-auto mb-4 opacity-50" />
                  <p>Select a student to view their progress report</p>
                </div>
              )}
            </div>
          </div>

          <style>{`
            @media print {
              body { background: white; }
              .print\\:hidden { display: none !important; }
              .print\\:shadow-none { box-shadow: none !important; }
            }
          `}</style>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<StudentProgressReport />);
  </script>
  
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    lucide.createIcons();
  </script>
</body>
</html>
